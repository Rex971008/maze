<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>迷宮探索遊戲 (平衡版)</title>
    <style>
        :root {
            --wall-color: #2c3e50; --path-color: #ecf0f1; --start-color: #2ecc71;
            --end-color: #e74c3c; --cleared-color: #f1c40f; --money-color: #27ae60;
            --diamond-color: #3498db; --player-size: 28px; --cell-size: 40px;
            --primary-bg: #34495e; --text-color: #ffffff; --button-bg: #3498db;
            --button-hover-bg: #2980b9; --danger-bg: #c0392b;
            --dark-color: #1a2531; --visible-transition: background-color 0.4s ease, opacity 0.4s ease;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; background-color: var(--primary-bg); color: var(--text-color); overflow: hidden; -webkit-user-select: none; user-select: none; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-sizing: border-box; padding: 20px; animation: fadeIn 0.5s ease-in-out; position: relative; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        h1 { font-size: 3em; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); } h2 { font-size: 2em; margin-bottom: 30px; } p { font-size: 1.2em; margin-top: 20px; }
        .button { background-color: var(--button-bg); color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.2em; cursor: pointer; margin: 10px; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.2); position: relative; }
        .button.danger { background-color: var(--danger-bg); } .button.danger:hover { background-color: #a53125; }
        .button:hover:not(:disabled) { background-color: var(--button-hover-bg); transform: translateY(-2px); } .button:active:not(:disabled) { transform: translateY(1px); }
        .button:disabled { background-color: #7f8c8d; cursor: not-allowed; opacity: 0.7; }
        .small-button { padding: 8px 15px; font-size: 0.9em; }
        #global-currency-display { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; background: rgba(0,0,0,0.3); padding: 10px 15px; border-radius: 20px; z-index: 10; font-size: 1.2em; font-weight: bold; }
        #money-display { color: var(--cleared-color); }
        #diamond-display { color: var(--diamond-color); }
        #level-select-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 800px; max-height: 70vh; overflow-y: auto; padding: 10px; margin-top: 15px; }
        .cleared-mark { position: absolute; top: -10px; right: -10px; font-size: 1.5em; color: var(--cleared-color); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); transform: rotate(15deg); }
        .button.treasure-hunt-btn { background: linear-gradient(45deg, var(--cleared-color), #f39c12); color: #2c3e50; font-weight: bold; border: 2px solid white; width: calc(100% - 20px); margin-left: auto; margin-right: auto; }
        #character-select-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; max-width: 600px; flex-wrap: wrap; margin-top: 15px;}
        .character-option { width: 80px; height: 80px; border: 3px solid transparent; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; background-color: #fff; padding: 5px; }
        .character-option:hover { transform: scale(1.1); border-color: var(--button-bg); } .character-option.selected { border-color: var(--start-color); transform: scale(1.2); box-shadow: 0 0 15px var(--start-color); }
        #game-screen { justify-content: flex-start; }
        #game-container { width: 100vw; height: 100vh; border: none; background-color: var(--dark-color); position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 0px; }
        #in-game-ui { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 20; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none; }
        #in-game-ui .button { pointer-events: all; }
        #game-actions { display: flex; gap: 10px; }
        .top-left-ui { display: flex; flex-direction: column; gap: 10px; align-items: flex-start;}
        #game-stats { display: flex; gap: 20px; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 10px; align-items: center; }
        #speed-boost-indicator { font-size: 1em; color: var(--cleared-color); font-weight: bold; display: none; }
        .stat-item { font-size: 1.2em; font-weight: bold; } #timer-display.bonus { color: var(--cleared-color); }
        /* 新增: 尋寶背包UI */
        #carried-loot-display { display: none; gap: 15px; background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 10px; font-size: 1.1em; font-weight: bold; }
        .loot-item span { margin-left: 5px; }

        #occupation-bar-container { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 50%; max-width: 400px; height: 20px; background-color: rgba(0,0,0,0.3); border: 2px solid #fff; border-radius: 10px; z-index: 20; opacity: 0; transition: opacity 0.3s ease; }
        #occupation-bar { width: 0%; height: 100%; background-color: var(--start-color); border-radius: 8px; transition: width 0.1s linear; }
        #occupation-bar-container.visible { opacity: 1; }
        #maze { position: absolute; display: grid; }
        #player { width: var(--player-size); height: var(--player-size); background-size: cover; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .monster { width: var(--player-size); height: var(--player-size); background-size: cover; border-radius: 8px; position: absolute; z-index: 9; transition: transform 0.1s linear, filter 0.5s ease, opacity 0.5s ease; opacity: 0; }
        .monster.visible { opacity: 1; }
        .monster.trapped { animation: shake 0.5s ease-in-out infinite; }
        .monster.dying { animation: monster-die 0.5s ease-out forwards; }
        @keyframes monster-die { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0); } }
        @keyframes shake { 0%, 100% { transform-origin: center center; } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .treasure { width: var(--player-size); height: var(--player-size); background-size: contain; background-repeat: no-repeat; background-position: center; position: absolute; z-index: 8; opacity: 0; }
        .treasure.visible { opacity: 1; transition: var(--visible-transition); }
        .treasure.opened { animation: treasure-open 0.5s ease-out forwards; }
        @keyframes treasure-open { 0% { transform: translateY(0) scale(1) rotate(0); opacity: 1; } 30% { transform: translateY(-10px) scale(1.1) rotate(15deg); } 100% { transform: translateY(-20px) scale(0) rotate(360deg); opacity: 0; } }
        .grid-cell { width: var(--cell-size); height: var(--cell-size); transition: var(--visible-transition); }
        .wall { background-color: var(--wall-color); opacity: 0.5; } .path, .start, .end { background-color: var(--dark-color); }
        .grid-cell.visible:not(.wall) { background-color: var(--path-color); } .grid-cell.start.visible { background-color: var(--start-color); } .grid-cell.end.visible { background-color: var(--end-color); }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 1.8em; }
        .spinner { border: 8px solid rgba(255, 255, 255, 0.3); border-top: 8px solid var(--button-bg); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        #win-rewards { width: 80%; max-width: 400px; text-align: left; margin-top: 20px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; }
        #win-rewards p { display: flex; justify-content: space-between; margin: 10px 0; font-size: 1.2em; } #win-rewards p span:last-child { color: var(--money-color); font-weight: bold; } #win-rewards hr { border-color: rgba(255,255,255,0.3); }
        #store-item-grid { display: flex; flex-direction: column; gap: 20px; width: 90%; max-width: 500px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; }
        .store-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; }
        .store-item-info { text-align: left; } .store-item-info h3 { margin: 0 0 5px; } .store-item-info p { margin: 0; font-size: 0.9em; opacity: 0.8; }
        .store-item-buy-action { position: relative; margin-left: 15px; }
        .store-item-buy-action .button { margin: 0; flex-shrink: 0; }
        .item-quantity-display { position: absolute; top: -10px; right: -10px; background-color: var(--end-color); color: var(--text-color); min-width: 24px; height: 24px; padding: 0 5px; border-radius: 12px; display: none; justify-content: center; align-items: center; font-size: 0.9em; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 1; }
        .item-quantity-display.active { background-color: var(--start-color); }
        #level-info-display { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; width: 90%; max-width: 500px; text-align: left; margin-bottom: 20px;}
        #level-info-display p { font-size: 1em; margin: 8px 0; display: flex; justify-content: space-between; }
        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 150px; height: 150px; display: none; z-index: 100; user-select: none; }
        #joystick-base { position: relative; width: 100%; height: 100%; background-color: rgba(52, 73, 94, 0.5); border-radius: 50%; border: 3px solid rgba(236, 240, 241, 0.5); }
        #joystick-handle { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; background-color: rgba(52, 152, 219, 0.8); border-radius: 50%; transform: translate(-50%, -50%); transition: transform 0.1s ease-out; }
        .item-cell { position: absolute; width: var(--cell-size); height: var(--cell-size); display: flex; justify-content: center; align-items: center; font-size: 28px; z-index: 7; opacity: 0; transition: opacity 0.4s ease; }
        .item-cell.visible { opacity: 0.7; }
        #custom-toast-notification { position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 20px); background-color: var(--button-bg); color: var(--text-color); padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.4s ease, transform 0.4s ease; font-weight: bold; white-space: pre-line; text-align: center; }
        #custom-toast-notification.show { opacity: 1; transform: translate(-50%, 0); }
    </style>
</head>
<body>
    <div id="home-screen" class="screen active"><div id="global-currency-display"><div id="money-display">💰 0</div><div id="diamond-display">💎 0</div></div><h1>迷宮探索</h1><div><button id="start-game-btn" class="button">開始遊戲</button><button id="store-btn" class="button">商店</button></div></div>
    <div id="level-select-screen" class="screen"><h2>選擇關卡</h2><button id="treasure-hunt-btn" class="button treasure-hunt-btn">🌟 寶藏礦脈 🌟</button><div id="level-select-grid"></div><button id="back-to-home-btn" class="button">返回主頁</button></div>
    <div id="character-select-screen" class="screen"><h2>選擇你的角色</h2><div id="level-info-display"></div><div id="character-select-grid"></div><p>選擇角色後即可開始遊戲</p><button id="back-to-level-from-char-btn" class="button">返回關卡選擇</button></div>
    <div id="game-screen" class="screen"><div id="game-container"><div id="maze"></div><div id="player"></div><div id="in-game-ui"><div class="top-left-ui"><div id="game-stats"><div id="speed-boost-indicator">⚡ 加速中</div><div class="stat-item" id="timer-display">⏱️ 00:00</div><div class="stat-item" id="game-money-display">💰 0</div></div><div id="carried-loot-display"><div class="loot-item" id="loot-money"></div><div class="loot-item" id="loot-traps"></div><div class="loot-item" id="loot-diamonds"></div></div></div><div id="game-actions"><button id="place-trap-btn" class="button small-button">陷阱(0)</button><button id="place-bomb-btn" class="button small-button">炸彈(0)</button><button id="exit-game-btn" class="button small-button">退出</button></div></div><div id="occupation-bar-container"><div id="occupation-bar"></div></div></div><div id="joystick-container"><div id="joystick-base"><div id="joystick-handle"></div></div></div></div>
    <div id="win-screen" class="screen"><h1 id="win-message">恭喜過關！</h1><div id="win-rewards"></div><button id="play-again-btn" class="button">回到關卡選擇</button></div>
    <div id="game-over-screen" class="screen"><h1>遊戲結束</h1><p>你被怪物抓住了！</p><button id="retry-btn" class="button danger">再試一次</button><button id="back-to-menu-btn" class="button">回到關卡選擇</button></div>
    <div id="store-screen" class="screen"><h1>商店</h1><div id="store-item-grid"><div class="store-item"><div class="store-item-info"><h3>風神祝福</h3><p>移動速度變為兩倍，持續一場遊戲。</p></div><div class="store-item-buy-action"><button id="buy-speed-boost-btn" class="button">💰 500</button><div class="item-quantity-display" id="speed-boost-quantity"></div></div></div><div class="store-item"><div class="store-item-info"><h3>捕獸夾 (消耗品)</h3><p>購買並儲存陷阱，在遊戲中使用。</p></div><div class="store-item-buy-action"><button id="buy-trap-btn" class="button">💰 250</button><div class="item-quantity-display" id="trap-quantity"></div></div></div><div class="store-item"><div class="store-item-info"><h3>炸彈 (消耗品)</h3><p>放置後可炸死一名接觸的怪物。</p></div><div class="store-item-buy-action"><button id="buy-bomb-btn" class="button">💰 400</button><div class="item-quantity-display" id="bomb-quantity"></div></div></div><div class="store-item"><div class="store-item-info"><h3>陷阱腰包 (永久)</h3><p>永久增加你每局遊戲的起始陷阱數量。</p></div><div class="store-item-buy-action"><button id="buy-trap-pouch-btn" class="button">💎 10</button><div class="item-quantity-display" id="trap-pouch-quantity"></div></div></div></div><button id="back-to-home-from-store-btn" class="button">返回主頁</button></div>
    <div id="loading-screen" class="screen"><div class="spinner"></div><p id="loading-message">載入中...</p></div>
    <div id="custom-toast-notification"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 變數宣告區 ---
    const screens = { home: document.getElementById('home-screen'), levelSelect: document.getElementById('level-select-screen'), characterSelect: document.getElementById('character-select-screen'), game: document.getElementById('game-screen'), win: document.getElementById('win-screen'), gameOver: document.getElementById('game-over-screen'), loading: document.getElementById('loading-screen'), store: document.getElementById('store-screen') };
    const mazeEl = document.getElementById("maze"), playerEl = document.getElementById("player"), gameContainer = document.getElementById("game-container"), levelSelectGrid = document.getElementById("level-select-grid"), moneyDisplayEl = document.getElementById("money-display"), timerDisplayEl = document.getElementById("timer-display"), gameMoneyDisplayEl = document.getElementById("game-money-display"), winRewardsEl = document.getElementById("win-rewards"), occupationBarContainer = document.getElementById("occupation-bar-container"), occupationBar = document.getElementById("occupation-bar");
    const joystickContainer = document.getElementById("joystick-container"), joystickHandle = document.getElementById("joystick-handle"), levelInfoDisplay = document.getElementById("level-info-display"), speedBoostIndicator = document.getElementById("speed-boost-indicator");
    const diamondDisplayEl = document.getElementById("diamond-display");
    const customToast = document.getElementById('custom-toast-notification');
    let toastTimeout = null;
    const buySpeedBoostBtn = document.getElementById("buy-speed-boost-btn"), speedBoostQuantityEl = document.getElementById("speed-boost-quantity");
    const buyTrapBtn = document.getElementById("buy-trap-btn"), trapQuantityEl = document.getElementById("trap-quantity");
    const buyBombBtn = document.getElementById("buy-bomb-btn"), bombQuantityEl = document.getElementById("bomb-quantity");
    const buyTrapPouchBtn = document.getElementById("buy-trap-pouch-btn"), trapPouchQuantityEl = document.getElementById("trap-pouch-quantity");
    const placeTrapBtn = document.getElementById("place-trap-btn"), placeBombBtn = document.getElementById("place-bomb-btn");
    const carriedLootDisplay = document.getElementById('carried-loot-display'), lootMoneyEl = document.getElementById('loot-money'), lootTrapsEl = document.getElementById('loot-traps'), lootDiamondsEl = document.getElementById('loot-diamonds');
    
    let gameState = { selectedLevel: null, selectedCharacterSrc: null, mazeData: [], playerPos: { x: 0, y: 0 }, monsters: [], treasures: [], placedTraps: [], placedBombs: [] };
    let gameSession = { timer:0, timerInterval:null, treasureBonus:0, timeBonus:0, occupationTimer:0, currentMoveSpeed: 0, trapsAvailable: 0, bombsAvailable: 0, carriedLoot: { money: 0, traps: 0, diamonds: 0 } };
    
    const mazeDesigns = { 1:{n:"新手上路",w:7,h:5,m:1,t:1,b:50,gt:30}, 2:{n:"林間小徑",w:10,h:8,m:2,t:1,b:60,gt:45}, 3:{n:"交叉路口",w:15,h:10,m:3,t:1,b:80,gt:60}, 4:{n:"蜿蜒長廊",w:20,h:12,m:4,t:1,b:100,gt:90}, 5:{n:"錯綜複雜",w:25,h:15,m:5,t:2,b:120,gt:120}, 6:{n:"深度監獄",w:30,h:20,m:6,t:2,b:150,gt:150}, 7:{n:"九曲迴腸",w:35,h:22,m:7,t:2,b:180,gt:180}, 8:{n:"蟻穴迷蹤",w:40,h:25,m:8,t:2,b:220,gt:210}, 9:{n:"無盡迴廊",w:45,h:28,m:10,t:2,b:250,gt:240}, 10:{n:"終極試煉",w:50,h:30,m:12,t:2,b:300,gt:300}, treasure_hunt: {n:"寶藏礦脈",w:25,h:20,m:20,t:30,b:0,gt:240, type:'hunt'} };
    
    const SAVE_KEY = "maze_save_data_v3";
    let savedData = { clearedLevels:{}, totalMoney:0, totalDiamonds:0, speedBoostActive: false, trapCount: 0, bombCount: 0, permanentTrapBonus: 0, levelRecords: {} };
    
    let playerMovement = { currentDirection: null, queuedDirection: null, moveInterval: null, lastPos:{x:-1, y:-1} };
    const BASE_PLAYER_MOVE_SPEED = 120, FOV_RADIUS = 10;
    const SPEED_BOOST_COST = 500, TRAP_COST = 250, TRAP_POUCH_COST = 10, BOMB_COST = 400;
    const MONSTER_TIERS = [ {level:1,colorFilter:"hue-rotate(0deg) saturate(0.8)",speed:480}, {level:2,colorFilter:"hue-rotate(90deg) saturate(1.2)",speed:360}, {level:3,colorFilter:"hue-rotate(200deg) saturate(1.5)",speed:240}, {level:4,colorFilter:"hue-rotate(280deg) saturate(2)",speed:150}, {level:5,colorFilter:"hue-rotate(350deg) saturate(2.5)",speed:120} ];
    let isTouchDevice = false;

    // --- 核心功能 (存檔、顯示) ---
    function loadGameData() { const data = localStorage.getItem(SAVE_KEY); const defaultData = { clearedLevels:{}, totalMoney:0, totalDiamonds:0, speedBoostActive: false, trapCount: 0, bombCount: 0, permanentTrapBonus: 0, levelRecords: {} }; savedData = data ? {...defaultData, ...JSON.parse(data)} : defaultData; updateGlobalCurrencyDisplay(); }
    function saveGameData() { localStorage.setItem(SAVE_KEY, JSON.stringify(savedData)); updateGlobalCurrencyDisplay(); }
    function updateGlobalCurrencyDisplay() { moneyDisplayEl.textContent = `💰 ${savedData.totalMoney}`; diamondDisplayEl.textContent = `💎 ${savedData.totalDiamonds}`; }
    function showToast(message) { if (toastTimeout) clearTimeout(toastTimeout); customToast.innerHTML = message; customToast.classList.add('show'); toastTimeout = setTimeout(() => { customToast.classList.remove('show'); }, 3000); }
    function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); if (screenName === 'levelSelect') { populateLevelSelect(); } if (screenName === 'store') { populateStore(); } if(screens[screenName]) screens[screenName].classList.add('active'); }
    function seededRandom(seed){let state=seed%2147483647;if(state<=0)state+=2147483646;return function(){state=state*16807%2147483647;return(state-1)/2147483646}}
    function showLoading(message="載入中..."){screens.loading.querySelector("#loading-message").textContent=message;screens.loading.style.display="flex"}
    function hideLoading(){screens.loading.style.display="none"}

    // --- 商店相關函數 ---
    function populateStore() { if (savedData.speedBoostActive) { speedBoostQuantityEl.textContent = '✓'; speedBoostQuantityEl.classList.add('active'); speedBoostQuantityEl.style.display = 'flex'; buySpeedBoostBtn.textContent = '已啟用'; buySpeedBoostBtn.disabled = true; } else { speedBoostQuantityEl.style.display = 'none'; speedBoostQuantityEl.classList.remove('active'); buySpeedBoostBtn.textContent = `💰 ${SPEED_BOOST_COST}`; buySpeedBoostBtn.disabled = savedData.totalMoney < SPEED_BOOST_COST; } if (savedData.trapCount > 0) { trapQuantityEl.textContent = savedData.trapCount; trapQuantityEl.style.display = 'flex'; } else { trapQuantityEl.style.display = 'none'; } buyTrapBtn.disabled = savedData.totalMoney < TRAP_COST; if (savedData.bombCount > 0) { bombQuantityEl.textContent = savedData.bombCount; bombQuantityEl.style.display = 'flex'; } else { bombQuantityEl.style.display = 'none'; } buyBombBtn.disabled = savedData.totalMoney < BOMB_COST; trapPouchQuantityEl.textContent = `+${savedData.permanentTrapBonus}`; trapPouchQuantityEl.style.display = savedData.permanentTrapBonus > 0 ? 'flex' : 'none'; buyTrapPouchBtn.disabled = savedData.totalDiamonds < TRAP_POUCH_COST; }
    function buySpeedBoost() { if (savedData.totalMoney >= SPEED_BOOST_COST && !savedData.speedBoostActive) { savedData.totalMoney -= SPEED_BOOST_COST; savedData.speedBoostActive = true; saveGameData(); populateStore(); showToast('購買「風神祝福」成功！'); } }
    function buyTrap() { if (savedData.totalMoney >= TRAP_COST) { savedData.totalMoney -= TRAP_COST; savedData.trapCount++; saveGameData(); populateStore(); showToast(`購買捕獸夾成功！\n庫存: ${savedData.trapCount} | 剩餘: ${savedData.totalMoney} 💰`); } }
    function buyBomb() { if (savedData.totalMoney >= BOMB_COST) { savedData.totalMoney -= BOMB_COST; savedData.bombCount++; saveGameData(); populateStore(); showToast(`購買炸彈成功！\n庫存: ${savedData.bombCount} | 剩餘: ${savedData.totalMoney} 💰`); } }
    function buyTrapPouch() { if (savedData.totalDiamonds >= TRAP_POUCH_COST) { savedData.totalDiamonds -= TRAP_POUCH_COST; savedData.permanentTrapBonus++; saveGameData(); populateStore(); showToast(`升級陷阱腰包！\n永久加成: +${savedData.permanentTrapBonus}`); } }
    
    // --- 遊戲內邏輯 ---
    function placeItem(type) { const pos = gameState.playerPos; const currentItems = type === 'trap' ? gameState.placedTraps : gameState.placedBombs; const otherItems = type === 'trap' ? gameState.placedBombs : gameState.placedTraps; if (currentItems.some(i => i.x === pos.x && i.y === pos.y) || otherItems.some(i => i.x === pos.x && i.y === pos.y)) return; const available = type === 'trap' ? gameSession.trapsAvailable : gameSession.bombsAvailable; if(available <= 0) return; if(type === 'trap') gameSession.trapsAvailable--; else gameSession.bombsAvailable--; if(type === 'trap') updatePlaceTrapButton(); else updatePlaceBombButton(); const newItem = { x: pos.x, y: pos.y }; currentItems.push(newItem); const cellSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size').trim()); const itemEl = document.createElement('div'); itemEl.className = 'item-cell'; itemEl.id = `${type}-${newItem.x}-${newItem.y}`; itemEl.textContent = type === 'trap' ? '🕸️' : '💣'; itemEl.style.transform = `translate(${newItem.x * cellSize}px, ${newItem.y * cellSize}px)`; mazeEl.appendChild(itemEl); if (visibleCells.has(`${newItem.x},${newItem.y}`)) { setTimeout(() => itemEl.classList.add('visible'), 50); } }
    function updatePlaceTrapButton() { placeTrapBtn.textContent = `陷阱(${gameSession.trapsAvailable})`; placeTrapBtn.disabled = gameSession.trapsAvailable <= 0; }
    function updatePlaceBombButton() { placeBombBtn.textContent = `炸彈(${gameSession.bombsAvailable})`; placeBombBtn.disabled = gameSession.bombsAvailable <= 0; }
    function handleEndGameItemSettlement() { const trapsPlaced = gameState.placedTraps.length; if (trapsPlaced > 0) { const consumableTrapsUsed = Math.max(0, trapsPlaced - savedData.permanentTrapBonus); savedData.trapCount = Math.max(0, savedData.trapCount - consumableTrapsUsed); } const bombsPlaced = gameState.placedBombs.length; savedData.bombCount = Math.max(0, savedData.bombCount - bombsPlaced); if (savedData.speedBoostActive) { savedData.speedBoostActive = false; } }
    
    function updateCarriedLootDisplay() {
        const { money, traps, diamonds } = gameSession.carriedLoot;
        const hasLoot = money > 0 || traps > 0 || diamonds > 0;
        carriedLootDisplay.style.display = hasLoot ? 'flex' : 'none';
        lootMoneyEl.innerHTML = money > 0 ? `💰<span>${money}</span>` : '';
        lootTrapsEl.innerHTML = traps > 0 ? `🛠️<span>${traps}</span>` : '';
        lootDiamondsEl.innerHTML = diamonds > 0 ? `💎<span>${diamonds}</span>` : '';
    }

    function handleOccupationAndCollection() {
        const currentPosKey = `${gameState.playerPos.x},${gameState.playerPos.y}`;
        const treasure = gameState.treasures.find(t => !t.opened && `${t.pos.x},${t.pos.y}` === currentPosKey);
        if (treasure) {
            treasure.opened = true;
            let foundMessage = "";
            if (mazeDesigns[gameState.selectedLevel].type === 'hunt') {
                const roll = Math.random();
                if (roll < 0.08) { // 鑽石
                    gameSession.carriedLoot.diamonds++;
                    foundMessage = "💎 撿到了 1 顆鑽石！";
                } else if (roll < 0.25) { // 陷阱
                    gameSession.carriedLoot.traps++;
                    foundMessage = `🛠️ 撿到了 1 個捕獸夾！`;
                } else { // 金錢
                    const bonusMoney = 200 + Math.floor(Math.random() * 301);
                    gameSession.carriedLoot.money += bonusMoney;
                    foundMessage = `💰 撿到了 ${bonusMoney} 金幣！`;
                }
                updateCarriedLootDisplay();
            } else { // 普通關卡
                gameSession.treasureBonus += treasure.value;
                updateGameMoneyDisplay();
                foundMessage = `💰 你找到了 ${treasure.value} 金幣！`;
            }
            showToast(foundMessage);
            const el = document.getElementById(`treasure-${treasure.id}`);
            if (el) el.classList.add("opened");
        }
        if (gameState.mazeData[gameState.playerPos.y]?.[gameState.playerPos.x] === 'E') { gameSession.occupationTimer += gameSession.currentMoveSpeed; occupationBarContainer.classList.add("visible"); const progress = Math.min(gameSession.occupationTimer / 3000 * 100, 100); occupationBar.style.width = `${progress}%`; if(gameSession.occupationTimer >= 3000){ winGame(); } } else { gameSession.occupationTimer = 0; occupationBarContainer.classList.remove("visible"); occupationBar.style.width = '0%'; }
    }
    
    function updateGameMoneyDisplay(){ gameMoneyDisplayEl.textContent = `💰 ${gameSession.treasureBonus}`; }

    // --- 遊戲流程 ---
    function winGame() {
        clearGameListeners();
        const levelConf = mazeDesigns[gameState.selectedLevel];

        if(levelConf.type === 'hunt') {
            const { money, traps, diamonds } = gameSession.carriedLoot;
            savedData.totalMoney += money;
            savedData.trapCount += traps;
            savedData.totalDiamonds += diamonds;
            
            let rewardsHTML = "<h3>成功帶出戰利品！</h3>";
            if (money > 0) rewardsHTML += `<p><span>金幣:</span> <span>+ ${money} 💰</span></p>`;
            if (traps > 0) rewardsHTML += `<p><span>捕獸夾:</span> <span>+ ${traps} 🛠️</span></p>`;
            if (diamonds > 0) rewardsHTML += `<p><span>鑽石:</span> <span>+ ${diamonds} 💎</span></p>`;
            if(money === 0 && traps === 0 && diamonds === 0) rewardsHTML += `<p>雖然什麼都沒帶出來...</p>`
            winRewardsEl.innerHTML = rewardsHTML;
        } else {
            const baseBonus = levelConf.b;
            if(levelConf.gt > 0 && gameSession.timer <= levelConf.gt) { gameSession.timeBonus = Math.floor(baseBonus * 1.5); }
            const totalWin = baseBonus + gameSession.timeBonus + gameSession.treasureBonus;
            savedData.totalMoney += totalWin;
            savedData.clearedLevels[gameState.selectedLevel] = true;
            const oldTime = savedData.levelRecords[gameState.selectedLevel]?.fastestTime;
            if (oldTime === undefined || gameSession.timer < oldTime) {
                if (!savedData.levelRecords[gameState.selectedLevel]) { savedData.levelRecords[gameState.selectedLevel] = {}; }
                savedData.levelRecords[gameState.selectedLevel].fastestTime = gameSession.timer;
            }
            winRewardsEl.innerHTML = `<p><span>基礎獎勵:</span> <span>+ ${baseBonus} 💰</span></p><p><span>限時獎勵:</span> <span>+ ${gameSession.timeBonus} 💰</span></p><p><span>寶箱獎勵:</span> <span>+ ${gameSession.treasureBonus} 💰</span></p><hr><p><span>總計獲得:</span> <span>+ ${totalWin} 💰</span></p>`;
        }
        
        handleEndGameItemSettlement(); // 結算消耗品
        saveGameData();
        showScreen("win");
    }
    
    function gameOver() { clearGameListeners(); handleEndGameItemSettlement(); saveGameData(); showScreen("gameOver"); }

    function startGame() {
        clearGameListeners(); gameState.placedTraps = []; gameState.placedBombs = [];
        mazeEl.querySelectorAll('.item-cell, .treasure, .monster').forEach(el => el.remove());
        const isHunt = mazeDesigns[gameState.selectedLevel].type === 'hunt';
        gameMoneyDisplayEl.style.display = isHunt ? 'none' : 'block';
        carriedLootDisplay.style.display = 'none';

        gameSession = { timer: 0, timerInterval: null, timeBonus: 0, treasureBonus: 0, occupationTimer: 0,
            currentMoveSpeed: savedData.speedBoostActive ? (BASE_PLAYER_MOVE_SPEED / 2) : BASE_PLAYER_MOVE_SPEED,
            trapsAvailable: savedData.trapCount + savedData.permanentTrapBonus, bombsAvailable: savedData.bombCount,
            carriedLoot: { money: 0, traps: 0, diamonds: 0 }
        };
        playerMovement = { currentDirection: null, queuedDirection: null, moveInterval: null, lastPos: {x:-1, y:-1} };
        speedBoostIndicator.style.display = savedData.speedBoostActive ? 'block' : 'none'; updatePlaceTrapButton(); updatePlaceBombButton();
        occupationBar.style.width = '0%'; occupationBarContainer.classList.remove('visible');
        playerEl.style.backgroundImage = `url(${gameState.selectedCharacterSrc})`;
        renderMaze(); computeFov(); updateFovDisplay();
        showScreen('game'); centerViewOnPlayer(false); updateGameMoneyDisplay(); hideLoading();
        document.addEventListener('keydown', handleKeyDown); document.addEventListener('keyup', handleKeyUp); addJoystickListeners();
        playerMovement.moveInterval = setInterval(mainGameLoop, gameSession.currentMoveSpeed);
        startGameTimer();
    }
    
    function populateLevelSelect(){ levelSelectGrid.innerHTML = ""; Object.keys(mazeDesigns).filter(l => l !== 'treasure_hunt').forEach(level => { const design=mazeDesigns[level]; const btn=document.createElement("button"); btn.className="level-select-btn button"; btn.dataset.level=level; btn.textContent=`第 ${level} 關: ${design.n}`; if(savedData.clearedLevels[level]){const mark=document.createElement("span");mark.className="cleared-mark";mark.textContent="🌟";btn.appendChild(mark)} btn.addEventListener("click",()=>{gameState.selectedLevel=level;populateCharacters();updateLevelInfoDisplay();showScreen("characterSelect")}); levelSelectGrid.appendChild(btn); }); }
    
    // --- 控制與主循環 (RESTORED TO ORIGINAL & STABLE) ---
    function mainGameLoop() {
        if (playerMovement.queuedDirection && canMove(gameState.playerPos, playerMovement.queuedDirection)) { playerMovement.currentDirection = playerMovement.queuedDirection; playerMovement.queuedDirection = null; }
        if (canMove(gameState.playerPos, playerMovement.currentDirection)) { let newPos = { ...gameState.playerPos }; const move = playerMovement.currentDirection; if (move === 'up') newPos.y--; else if (move === 'down') newPos.y++; else if (move === 'left') newPos.x--; else if (move === 'right') newPos.x++; gameState.playerPos = newPos; centerViewOnPlayer(true); } else { playerMovement.currentDirection = null; }
        if (playerMovement.lastPos.x !== gameState.playerPos.x || playerMovement.lastPos.y !== gameState.playerPos.y) { computeFov(); updateFovDisplay(); playerMovement.lastPos = {...gameState.playerPos}; }
        handleOccupationAndCollection();
        const cellSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-size').trim());
        for (let i = gameState.monsters.length - 1; i >= 0; i--) { const monster = gameState.monsters[i]; if (!monster.moveCooldown) monster.moveCooldown = 0; monster.moveCooldown += gameSession.currentMoveSpeed; if (monster.moveCooldown >= monster.speed) { updateSingleMonsterAI(monster, i); const monsterEl = document.getElementById(`monster-${monster.id}`); if (monsterEl && monster.state !== 'TRAPPED') { monsterEl.style.transform = `translate(${monster.pos.x * cellSize}px, ${monster.pos.y * cellSize}px)`; } monster.moveCooldown = 0; } }
        for (const monster of gameState.monsters) { if (monster.pos.x === gameState.playerPos.x && monster.pos.y === gameState.playerPos.y) { gameOver(); return; } }
    }

    // --- 剩餘輔助函數 (穩定版本) ---
    function updateSingleMonsterAI(monster, index) { const monsterEl = document.getElementById(`monster-${monster.id}`); if (monster.state === 'TRAPPED') { if (Date.now() > monster.trappedUntil) { monster.state = 'IDLE'; if (monsterEl) monsterEl.classList.remove('trapped'); } else { return; } } const playerVisible = isPlayerVisible(monster.pos, gameState.playerPos); switch (monster.state) { case "IDLE": if(playerVisible) monster.state="CHASING"; break; case "CHASING": if(playerVisible) { monster.lastKnownPlayerPos={...gameState.playerPos} } else { monster.state="SEARCHING" } break; case "SEARCHING": if(playerVisible) { monster.state="CHASING" } else if(monster.lastKnownPlayerPos && monster.pos.x===monster.lastKnownPlayerPos.x && monster.pos.y===monster.lastKnownPlayerPos.y) { monster.state="RETURNING" } break; case "RETURNING": if(monster.pos.x===monster.spawnPos.x&&monster.pos.y===monster.spawnPos.y) { monster.state="IDLE" } break; } let targetPos = null; if(monster.state==="CHASING") targetPos = gameState.playerPos; else if(monster.state==="SEARCHING") targetPos = monster.lastKnownPlayerPos; else if(monster.state==="RETURNING") targetPos = monster.spawnPos; if (targetPos) { const path = findPath(monster.pos, targetPos); if (path && path.length > 1) { const nextPos = path[1]; const bombIndex = gameState.placedBombs.findIndex(b => b.x === nextPos.x && b.y === nextPos.y); if (bombIndex !== -1) { const bombData = gameState.placedBombs.splice(bombIndex, 1)[0]; const bombEl = document.getElementById(`bomb-${bombData.x}-${bombData.y}`); if (bombEl) bombEl.remove(); if (monsterEl) { monsterEl.classList.add('dying'); setTimeout(() => monsterEl.remove(), 500); } gameState.monsters.splice(index, 1); return; } const trapIndex = gameState.placedTraps.findIndex(t => t.x === nextPos.x && t.y === nextPos.y); if (trapIndex !== -1) { monster.state = 'TRAPPED'; monster.trappedUntil = Date.now() + 3000 + Math.random() * 2000; if (monsterEl) monsterEl.classList.add('trapped'); const trapData = gameState.placedTraps.splice(trapIndex, 1)[0]; const trapEl = document.getElementById(`trap-${trapData.x}-${trapData.y}`); if (trapEl) trapEl.remove(); return; } monster.pos = nextPos; } } }
    function formatTime(seconds){if(seconds===null||seconds===undefined)return"N/A";const minutes=Math.floor(seconds/60).toString().padStart(2,"0");const secs=(seconds%60).toString().padStart(2,"0");return`${minutes}:${secs}`}
    function updateLevelInfoDisplay(){const level=gameState.selectedLevel;if(!level||!mazeDesigns[level])return;const design=mazeDesigns[level];const record=savedData.levelRecords[level];const fastestTime=record?record.fastestTime:undefined;levelInfoDisplay.innerHTML=`<p><span>關卡名稱</span> <span>${design.n}</span></p><p><span>迷宮大小</span> <span>${design.w*2+1}x${design.h*2+1}</span></p><p><span>怪物數量</span> <span>${design.m}</span></p><p><span>寶箱數量</span> <span>${design.t}</span></p><p><span>最快紀錄</span> <span>${design.type==='hunt'?'N/A':formatTime(fastestTime)}</span></p>`}
    function populateCharacters(){const grid=document.getElementById("character-select-grid");grid.innerHTML="";const styles=["adventurer","avataaars","big-ears","fun-emoji","icons","identicon","miniavs","pixel-art","shapes","thumbs"];styles.forEach(style=>{const seed=Math.random().toString(36).substring(7);const imgUrl=`https://api.dicebear.com/8.x/${style}/svg?seed=${seed}&radius=50`;const charDiv=document.createElement("img");charDiv.src=imgUrl;charDiv.classList.add("character-option");charDiv.addEventListener("click",()=>{grid.querySelectorAll(".character-option").forEach(el=>el.classList.remove("selected"));charDiv.classList.add("selected");gameState.selectedCharacterSrc=imgUrl;showLoading("正在生成迷宮...");setTimeout(startGame,50)});grid.appendChild(charDiv)})}
    function centerViewOnPlayer(animated=!0){const cellSize=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--cell-size").trim());const containerWidth=gameContainer.clientWidth;const containerHeight=gameContainer.clientHeight;const mazeX=-gameState.playerPos.x*cellSize+containerWidth/2-cellSize/2;const mazeY=-gameState.playerPos.y*cellSize+containerHeight/2-cellSize/2;mazeEl.style.transition=animated?`transform ${gameSession.currentMoveSpeed}ms linear`:"none";mazeEl.style.transform=`translate(${mazeX}px, ${mazeY}px)`}
    let visibleCells=new Set;function computeFov(){visibleCells.clear();visibleCells.add(`${gameState.playerPos.x},${gameState.playerPos.y}`);const octants=[{xx:1,xy:0,yx:0,yy:1},{xx:0,xy:1,yx:1,yy:0},{xx:0,xy:-1,yx:1,yy:0},{xx:-1,xy:0,yx:0,yy:1},{xx:-1,xy:0,yx:0,yy:-1},{xx:0,xy:-1,yx:-1,yy:0},{xx:0,xy:1,yx:-1,yy:0},{xx:1,xy:0,yx:0,yy:-1}];octants.forEach(octant=>{castLight(1,1,0,octant.xx,octant.xy,octant.yx,octant.yy)})}
    function castLight(row,start,end,xx,xy,yx,yy){let newStart=0;if(start<end){return}let radius_sq=FOV_RADIUS*FOV_RADIUS;for(let j=row;j<=FOV_RADIUS;j++){let dx=-j-1;let dy=-j;let blocked=!1;while(dx<=0){dx++;let mapX=gameState.playerPos.x+dx*xx+dy*xy;let mapY=gameState.playerPos.y+dx*yx+dy*yy;if(mapX<0||mapX>=gameState.mazeData[0].length||mapY<0||mapY>=gameState.mazeData.length){continue}let lSlope=(dx-.5)/(dy+.5);let rSlope=(dx+.5)/(dy-.5);if(start<rSlope){continue}else if(end>lSlope){break}if(dx*dx+dy*dy<radius_sq){visibleCells.add(`${mapX},${mapY}`)}let currentCellIsWall=gameState.mazeData[mapY]?.[mapX]==="W";if(blocked){if(currentCellIsWall){newStart=rSlope;continue}else{blocked=!1;start=newStart}}else{if(currentCellIsWall&&j<FOV_RADIUS){blocked=!0;castLight(j+1,start,lSlope,xx,xy,yx,yy);newStart=rSlope}}}if(blocked){break}}}
    function updateFovDisplay(){const mazeWidth=gameState.mazeData[0].length;mazeEl.querySelectorAll(".grid-cell.visible").forEach(el=>el.classList.remove("visible"));visibleCells.forEach(key=>{const[x,y]=key.split(",").map(Number);const index=y*mazeWidth+x;const cell=mazeEl.children[index];if(cell&&!cell.classList.contains("wall")){cell.classList.add("visible")}});gameState.monsters.forEach(m=>{document.getElementById(`monster-${m.id}`)?.classList.toggle("visible",visibleCells.has(`${m.pos.x},${m.pos.y}`))});gameState.treasures.forEach(t=>{const el=document.getElementById(`treasure-${t.id}`);if(el)el.classList.toggle("visible",visibleCells.has(`${t.pos.x},${t.pos.y}`))});[...gameState.placedTraps, ...gameState.placedBombs].forEach(item => {const itemEl = document.getElementById(`trap-${item.x}-${item.y}`) || document.getElementById(`bomb-${item.x}-${item.y}`); if(itemEl) itemEl.classList.toggle('visible', visibleCells.has(`${item.x},${item.y}`))})}
    function renderMaze(){mazeEl.innerHTML="";gameState.monsters=[];gameState.treasures=[];const levelConfig=mazeDesigns[gameState.selectedLevel];gameState.mazeData=generateMaze(levelConfig.w,levelConfig.h,parseInt(gameState.selectedLevel) || Math.random()*10000);placeTreasuresAndMonsters();const mazeWidth=gameState.mazeData[0].length;const cellSize=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--cell-size").trim());mazeEl.style.gridTemplateColumns=`repeat(${mazeWidth}, ${cellSize}px)`;let content="";gameState.mazeData.forEach((row,y)=>{row.forEach((cellType,x)=>{let cellClass="";if(cellType==="S"){gameState.playerPos={x,y};cellClass="start"}else if(cellType==="W")cellClass="wall";else if(cellType==="P"||cellType==="T"||cellType==="M")cellClass="path";else if(cellType==="E")cellClass="end";content+=`<div class="grid-cell ${cellClass}"></div>`})});mazeEl.innerHTML=content;gameState.treasures.forEach(treasure=>{const el=document.createElement("div");el.id=`treasure-${treasure.id}`;el.className="treasure";el.style.backgroundImage=`url(https://labs.phaser.io/assets/sprites/crate.png)`;el.style.transform=`translate(${treasure.pos.x*cellSize}px, ${treasure.pos.y*cellSize}px)`;mazeEl.appendChild(el)});gameState.monsters.forEach(monster=>{const el=document.createElement("div");el.id=`monster-${monster.id}`;el.className="monster";el.style.backgroundImage=`url(https://api.dicebear.com/8.x/bottts-neutral/svg?seed=${monster.id}&radius=8&backgroundColor=d1d1d1)`;el.style.transform=`translate(${monster.pos.x*cellSize}px, ${monster.pos.y*cellSize}px)`;el.style.filter=monster.colorFilter;mazeEl.appendChild(el)})}
    function placeTreasuresAndMonsters() { const rng = seededRandom(parseInt(gameState.selectedLevel) || Math.random()*10000); const levelConf = mazeDesigns[gameState.selectedLevel]; const allDeadEnds = []; for (let y = 1; y < gameState.mazeData.length - 1; y++) { for (let x = 1; x < gameState.mazeData[y].length - 1; x++) { if (gameState.mazeData[y][x] === 'P') { let wallCount = 0; if (gameState.mazeData[y-1][x] === 'W') wallCount++; if (gameState.mazeData[y+1][x] === 'W') wallCount++; if (gameState.mazeData[y][x-1] === 'W') wallCount++; if (gameState.mazeData[y][x+1] === 'W') wallCount++; if (wallCount >= 3) { if(getDistance({ x, y }, { x:1, y:1 }) > 5) { const depth = findPath({x, y}, {x: 1, y: 1})?.length || 0; allDeadEnds.push({pos: {x,y}, depth}); }} } } } allDeadEnds.sort((a,b)=>b.depth-a.depth); const treasurePlacedAt = new Set(); for (let i = 0; i < levelConf.t && i < allDeadEnds.length; i++) { const pos=allDeadEnds[i].pos; gameState.mazeData[pos.y][pos.x]="T"; gameState.treasures.push({id: i, pos: pos, opened: false, value: (50+Math.floor(levelConf.b/2))*10}); treasurePlacedAt.add(`${pos.x},${pos.y}`); } let monsterSpawns = [...allDeadEnds].sort(()=>rng()-0.5); for (let i = 0; i < levelConf.m && i < monsterSpawns.length; i++) { const spawnPoint=monsterSpawns[i]; const isNearTreasure = Array.from(treasurePlacedAt).some(tPosStr => { const [tx,ty] = tPosStr.split(',').map(Number); return getDistance(spawnPoint.pos, {x:tx, y:ty}) < 5; }); let tierIndex = Math.floor(rng()*Math.min(parseInt(gameState.selectedLevel)/1.8 || 1, MONSTER_TIERS.length)); if(isNearTreasure) { tierIndex = Math.min(tierIndex + 2, MONSTER_TIERS.length - 1); } const tier = MONSTER_TIERS[tierIndex]; gameState.monsters.push({...tier, id:i, pos:{...spawnPoint.pos}, spawnPos:{...spawnPoint.pos}, state:'IDLE', lastKnownPlayerPos:null, moveCooldown:0, trappedUntil: 0}); } }
    function canMove(pos,direction){if(!direction)return false; let newPos={...pos};if(direction==="up")newPos.y--;else if(direction==="down")newPos.y++;else if(direction==="left")newPos.x--;else if(direction==="right")newPos.x++;const targetCell=gameState.mazeData[newPos.y]?.[newPos.x];return targetCell&&targetCell!=="W"}
    function generateMaze(width,height,seed){const rng=seededRandom(seed);const grid=Array.from({length:height*2+1},()=>Array(width*2+1).fill("W"));function carve(cx,cy){const directions=["N","S","E","W"].sort(()=>rng()-.5);for(const direction of directions){const[dx,dy]={N:[0,-2],S:[0,2],E:[2,0],W:[-2,0]}[direction];const nx=cx+dx,ny=cy+dy;if(ny>=0&&ny<height*2+1&&nx>=0&&nx<width*2+1&&grid[ny][nx]==="W"){grid[ny-dy/2][nx-dx/2]="P";grid[ny][nx]="P";carve(nx,ny)}}}grid[1][1]="P";carve(1,1);grid[1][1]="S";grid[height*2-1][width*2-1]="E";return grid}
    function getDistance(pos1,pos2){return Math.sqrt(Math.pow(pos1.x-pos2.x,2)+Math.pow(pos1.y-pos2.y,2))}
    function findPath(start,end){const queue=[[start]];const visited=new Set([`${start.x},${start.y}`]);const directions=["up","down","left","right"];while(queue.length>0){const path=queue.shift();const pos=path[path.length-1];if(pos.x===end.x&&pos.y===end.y)return path;for(const dir of directions){let nextPos={...pos};if(dir==="up")nextPos.y--;else if(dir==="down")nextPos.y++;else if(dir==="left")nextPos.x--;else if(dir==="right")nextPos.x++;const key=`${nextPos.x},${nextPos.y}`;if(!visited.has(key)&&canMove(pos,dir)){visited.add(key);const newPath=[...path,nextPos];queue.push(newPath)}}}return null}
    function isPlayerVisible(monsterPos,playerPos){if(getDistance(monsterPos,playerPos)>FOV_RADIUS)return!1;let x0=monsterPos.x,y0=monsterPos.y;const x1=playerPos.x,y1=playerPos.y;const dx=Math.abs(x1-x0),sx=x0<x1?1:-1;const dy=-Math.abs(y1-y0),sy=y0<y1?1:-1;let err=dx+dy,e2;while(!0){if(gameState.mazeData[y0]?.[x0]==="W")return!1;if(x0===x1&&y0===y1)break;e2=2*err;if(e2>=dy){err+=dy;x0+=sx}if(e2<=dx){err+=dx;y0+=sy}}return!0}
    function handleKeyDown(e){const keyMap={ArrowUp:"up",w:"up",ArrowDown:"down",s:"down",ArrowLeft:"left",a:"left",ArrowRight:"right",d:"right"};const direction=keyMap[e.key];if(!direction)return;e.preventDefault();playerMovement.queuedDirection=direction;if(!playerMovement.currentDirection)playerMovement.currentDirection=direction;}
    function handleKeyUp(e){const keyMap={ArrowUp:"up",w:"up",ArrowDown:"down",s:"down",ArrowLeft:"left",a:"left",ArrowRight:"right",d:"right"};const direction=keyMap[e.key];if(direction===playerMovement.queuedDirection)playerMovement.queuedDirection=null;}
    let isJoystickDragging=!1;let joystickOrigin={x:0,y:0};let maxJoystickRadius=0;function joystickTouchStart(e){e.preventDefault();isJoystickDragging=!0;const rect=joystickContainer.getBoundingClientRect();joystickOrigin={x:rect.left+rect.width/2,y:rect.top+rect.height/2};maxJoystickRadius=joystickContainer.offsetWidth/2-joystickHandle.offsetWidth/2;joystickTouchMove(e)}
    function joystickTouchMove(e){if(!isJoystickDragging)return;e.preventDefault();const touch=e.touches[0];let dx=touch.clientX-joystickOrigin.x;let dy=touch.clientY-joystickOrigin.y;const distance=Math.sqrt(dx*dx+dy*dy);if(distance>maxJoystickRadius){dx=dx/distance*maxJoystickRadius;dy=dy/distance*maxJoystickRadius}joystickHandle.style.transform=`translate(-50%, -50%) translate(${dx}px, ${dy}px)`;let direction=null;if(distance<20){direction=null} else {if(Math.abs(dx)>Math.abs(dy)){direction=dx>0?"right":"left"}else{direction=dy>0?"down":"up"}}playerMovement.queuedDirection=direction;if(!playerMovement.currentDirection)playerMovement.currentDirection=direction;}
    function joystickTouchEnd(e){if(!isJoystickDragging)return;e.preventDefault();isJoystickDragging=!1;joystickHandle.style.transform="translate(-50%, -50%)";playerMovement.queuedDirection=null; playerMovement.currentDirection=null;}
    function addJoystickListeners(){if(!isTouchDevice)return;joystickContainer.style.display="block";joystickContainer.addEventListener("touchstart",joystickTouchStart,{passive:!1});document.addEventListener("touchmove",joystickTouchMove,{passive:!1});document.addEventListener("touchend",joystickTouchEnd,{passive:!1});document.addEventListener("touchcancel",joystickTouchEnd,{passive:!1})}
    function removeJoystickListeners(){if(!isTouchDevice)return;joystickContainer.style.display="none";joystickContainer.removeEventListener("touchstart",joystickTouchStart);document.removeEventListener("touchmove",joystickTouchMove);document.removeEventListener("touchend",joystickTouchEnd);document.removeEventListener("touchcancel",joystickTouchEnd)}
    function clearGameListeners(){clearInterval(playerMovement.moveInterval);clearInterval(gameSession.timerInterval);document.removeEventListener("keydown",handleKeyDown);document.removeEventListener("keyup",handleKeyUp);removeJoystickListeners()}
    function startGameTimer(){const goldTime=mazeDesigns[gameState.selectedLevel]?.gt;gameSession.timerInterval=setInterval(()=>{gameSession.timer++;const minutes=Math.floor(gameSession.timer/60).toString().padStart(2,"0");const seconds=(gameSession.timer%60).toString().padStart(2,"0");timerDisplayEl.textContent=`⏱️ ${minutes}:${seconds}`;if (goldTime > 0) { timerDisplayEl.classList.toggle("bonus", gameSession.timer <= goldTime); } },1000)}
    
    // --- 初始化與事件監聽 ---
    document.getElementById('start-game-btn').addEventListener('click',()=>showScreen('levelSelect'));
    document.getElementById('store-btn').addEventListener('click',()=>showScreen('store'));
    document.getElementById('treasure-hunt-btn').addEventListener('click', () => { gameState.selectedLevel = 'treasure_hunt'; populateCharacters(); updateLevelInfoDisplay(); showScreen("characterSelect"); });
    document.getElementById('back-to-home-from-store-btn').addEventListener('click',()=>showScreen('home'));
    document.getElementById('back-to-home-btn').addEventListener('click',()=>showScreen('home'));
    document.getElementById('back-to-level-from-char-btn').addEventListener('click',()=>showScreen('levelSelect'));
    document.getElementById('play-again-btn').addEventListener('click',()=>{clearGameListeners();showScreen('levelSelect')});
    document.getElementById('retry-btn').addEventListener('click',()=>{clearGameListeners();showLoading("正在重新生成迷宮...");setTimeout(startGame,50)});
    document.getElementById('back-to-menu-btn').addEventListener('click',()=>{clearGameListeners();showScreen('levelSelect')});
    document.getElementById('exit-game-btn').addEventListener('click',()=>{clearGameListeners();showScreen('levelSelect')});
    buySpeedBoostBtn.addEventListener('click', buySpeedBoost);
    buyTrapBtn.addEventListener('click', buyTrap);
    buyBombBtn.addEventListener('click', buyBomb);
    buyTrapPouchBtn.addEventListener('click', buyTrapPouch);
    placeTrapBtn.addEventListener('click', () => placeItem('trap'));
    placeBombBtn.addEventListener('click', () => placeItem('bomb'));
    isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    loadGameData();
    showScreen('home');
});
</script>
</body>
</html>